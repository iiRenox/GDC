-- File: ServerScriptService/Services/TeslaService
-- Modified/Created by: GPT-5 (Cursor) â€” 2025-08-09
-- Summary: Tesla aura that damages only enemy units/vehicles, never buildings. Visual bolts optional later.

local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local GameConfig = require(ReplicatedStorage:WaitForChild("GameConfig"))

local TeslaService = {}

local activeTeslas = {}
local AURA_RADIUS = 135
local TICK = 0.25 -- 4 Hz
local DPS = 6 -- tune

function TeslaService:RegisterTesla(coreId: string, plot, model: Model, ownerTeam)
    activeTeslas[model] = { coreId = coreId, plot = plot, model = model, ownerTeam = ownerTeam }
    model.Destroying:Connect(function() activeTeslas[model] = nil end)
end

local accumulated = 0
RunService.Heartbeat:Connect(function(dt)
    accumulated += dt
    if accumulated < TICK then return end
    accumulated = 0
    for m, info in pairs(activeTeslas) do
        if not (m and m.Parent) then activeTeslas[m] = nil else
            local center = (m.PrimaryPart or m:FindFirstChildWhichIsA("BasePart"))
            if center then
                for _, inst in ipairs(Workspace:GetDescendants()) do
                    if inst:IsA("Model") then
                        -- skip buildings
                        if inst:GetAttribute("IsBuilding") then continue end
                        -- basic team check by player Team for characters; vehicles: infer by proximity/owner if needed later
                        local hum = inst:FindFirstChildOfClass("Humanoid")
                        local root = inst:FindFirstChild("HumanoidRootPart") or inst.PrimaryPart
                        if root then
                            local dist = (root.Position - center.Position).Magnitude
                            if dist <= AURA_RADIUS then
                                -- team filter: if character has a Player with team equal to ownerTeam, skip
                                local okHit = true
                                if hum then
                                    local plr = game:GetService("Players"):GetPlayerFromCharacter(inst)
                                    if plr and plr.Team then
                                        local repName = GameConfig.Teams[2].Name
                                        local cisName = GameConfig.Teams[1].Name
                                        local teamId = (plr.Team.Name == repName) and GameConfig.TEAM.REP or (plr.Team.Name == cisName) and GameConfig.TEAM.CIS or nil
                                        if teamId == info.ownerTeam then okHit = false end
                                    end
                                end
                                -- vehicle/troop models: honor OwnerTeam attribute to avoid friendly fire
                                if okHit then
                                    local ownerTid = inst:GetAttribute("OwnerTeam")
                                    if ownerTid and ownerTid == info.ownerTeam then okHit = false end
                                end
                                if okHit then
                                    -- apply damage to humanoids or Health carriers (vehicles/units), not buildings
                                    if hum then
                                        hum:TakeDamage(math.max(1, math.floor(DPS * TICK)))
                                    else
                                        local hv = inst:FindFirstChild("Health")
                                        if hv and hv:IsA("IntValue") then hv.Value = math.max(0, hv.Value - math.max(1, math.floor(DPS * TICK))) end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end
end)

return TeslaService


